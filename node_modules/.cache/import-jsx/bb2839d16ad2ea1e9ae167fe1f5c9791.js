'use strict';

const React = require('react');

const {
  useState,
  useEffect,
  useContext
} = require('react');

const importJsx = require('import-jsx');

const {
  Text,
  Box
} = require('ink');

const useInterval = require('./useInterval');

const {
  default: StdinContext
} = require('ink/build/components/StdinContext');

const DiedScreen = importJsx('./DiedScreen');
const FIELD_SIZE = 16;
const FIELD_ROW = [...new Array(FIELD_SIZE).keys()];
const ARROW_UP = '\u001B[A';
const ARROW_DOWN = '\u001B[B';
const ARROW_LEFT = '\u001B[D';
const ARROW_RIGHT = '\u001B[C';
let foodItem = {
  x: Math.floor(Math.random() * FIELD_SIZE),
  y: Math.floor(Math.random() * FIELD_SIZE)
};
const DIRECTION = {
  RIGHT: {
    x: 1,
    y: 0
  },
  LEFT: {
    x: -1,
    y: 0
  },
  TOP: {
    x: 0,
    y: -1
  },
  BOTTOM: {
    x: 0,
    y: 1
  }
};

function getItem(x, y, snakeSegents) {
  if (foodItem.x === x && foodItem.y === y) {
    return /*#__PURE__*/React.createElement(Text, {
      color: "red"
    }, " \u25A0 ");
  }

  for (const segment of snakeSegents) {
    if (segment.x === x && segment.y === y) {
      return /*#__PURE__*/React.createElement(Text, {
        color: "green"
      }, " \u25A0 ");
    }
  }
}

function limitByField(x) {
  if (x >= FIELD_SIZE) {
    return 0;
  }

  if (x < 0) {
    return FIELD_SIZE - 1;
  }

  return x;
}

function newSnakePosition(segments, direction) {
  const [head] = segments;
  const newHead = {
    x: limitByField(head.x + direction.x),
    y: limitByField(head.y + direction.y)
  };

  if (SnakeEatFood(newHead, foodItem)) {
    foodItem = {
      x: Math.floor(Math.random() * FIELD_SIZE),
      y: Math.floor(Math.random() * FIELD_SIZE)
    };
    return [newHead, ...segments];
  }

  return [newHead, ...segments.slice(0, -1)];
}

function SnakeEatFood(head, foodItem) {
  return head.x === foodItem.x && head.y === foodItem.y;
}

const App = () => {
  const [snakeSegents, setSnakeSegments] = useState([{
    x: 8,
    y: 8
  }, {
    x: 8,
    y: 7
  }, {
    x: 8,
    y: 6
  }]);
  const [direction, setDirection] = useState(DIRECTION.LEFT);
  const {
    stdin,
    setRawMode
  } = useContext(StdinContext);
  useEffect(() => {
    setRawMode(true);
    stdin.on('data', data => {
      const value = data.toString();

      if (value == ARROW_UP) {
        setDirection(DIRECTION.TOP);
      }

      if (value == ARROW_DOWN) {
        setDirection(DIRECTION.BOTTOM);
      }

      if (value == ARROW_LEFT) {
        setDirection(DIRECTION.LEFT);
      }

      if (value == ARROW_RIGHT) {
        setDirection(DIRECTION.RIGHT);
      }
    });
  }, []);
  const [head, ...tail] = snakeSegents;
  const intersectWithItself = tail.some(segment => segment.x === head.x && segment.y === head.y);
  useInterval(() => {
    setSnakeSegments(segments => newSnakePosition(segments, direction));
  }, intersectWithItself ? null : 80);
  return /*#__PURE__*/React.createElement(Box, {
    flexDirection: "column",
    alignItems: "center"
  }, /*#__PURE__*/React.createElement(Text, null, /*#__PURE__*/React.createElement(Text, {
    color: "green"
  }, "Snake"), " game"), intersectWithItself ? /*#__PURE__*/React.createElement(DiedScreen, {
    size: FIELD_SIZE
  }) : /*#__PURE__*/React.createElement(Box, {
    flexDirection: "column"
  }, FIELD_ROW.map(y => /*#__PURE__*/React.createElement(Box, {
    key: y
  }, FIELD_ROW.map(x => /*#__PURE__*/React.createElement(Box, {
    key: x
  }, getItem(x, y, snakeSegents) || /*#__PURE__*/React.createElement(Text, null, " . ")))))));
};

module.exports = App;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVpLmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwicmVxdWlyZSIsInVzZVN0YXRlIiwidXNlRWZmZWN0IiwidXNlQ29udGV4dCIsImltcG9ydEpzeCIsIlRleHQiLCJCb3giLCJ1c2VJbnRlcnZhbCIsImRlZmF1bHQiLCJTdGRpbkNvbnRleHQiLCJEaWVkU2NyZWVuIiwiRklFTERfU0laRSIsIkZJRUxEX1JPVyIsIkFycmF5Iiwia2V5cyIsIkFSUk9XX1VQIiwiQVJST1dfRE9XTiIsIkFSUk9XX0xFRlQiLCJBUlJPV19SSUdIVCIsImZvb2RJdGVtIiwieCIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsInkiLCJESVJFQ1RJT04iLCJSSUdIVCIsIkxFRlQiLCJUT1AiLCJCT1RUT00iLCJnZXRJdGVtIiwic25ha2VTZWdlbnRzIiwic2VnbWVudCIsImxpbWl0QnlGaWVsZCIsIm5ld1NuYWtlUG9zaXRpb24iLCJzZWdtZW50cyIsImRpcmVjdGlvbiIsImhlYWQiLCJuZXdIZWFkIiwiU25ha2VFYXRGb29kIiwic2xpY2UiLCJBcHAiLCJzZXRTbmFrZVNlZ21lbnRzIiwic2V0RGlyZWN0aW9uIiwic3RkaW4iLCJzZXRSYXdNb2RlIiwib24iLCJkYXRhIiwidmFsdWUiLCJ0b1N0cmluZyIsInRhaWwiLCJpbnRlcnNlY3RXaXRoSXRzZWxmIiwic29tZSIsIm1hcCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxRQUFGO0FBQVlDLEVBQUFBLFNBQVo7QUFBdUJDLEVBQUFBO0FBQXZCLElBQXNDSCxPQUFPLENBQUMsT0FBRCxDQUFuRDs7QUFDQSxNQUFNSSxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxZQUFELENBQXpCOztBQUNBLE1BQU07QUFBRUssRUFBQUEsSUFBRjtBQUFRQyxFQUFBQTtBQUFSLElBQWdCTixPQUFPLENBQUMsS0FBRCxD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LEVBRVJlLG1CQUFtQixHQUFHLElBQUgsR0FBVSxFQUZyQixDQUFYO0FBSUEsc0JBQ0Msb0JBQUMsR0FBRDtBQUFLLElBQUEsYUFBYSxFQUFDLFFBQW5CO0FBQTRCLElBQUEsVUFBVSxFQUFDO0FBQXZDLGtCQUNDLG9CQUFDLElBQUQscUJBQ0Msb0JBQUMsSUFBRDtBQUFNLElBQUEsS0FBSyxFQUFDO0FBQVosYUFERCxVQURELEVBSUVBLG1CQUFtQixnQkFDbkIsb0JBQUMsVUFBRDtBQUFZLElBQUEsSUFBSSxFQUFFeEM7QUFBbEIsSUFEbUIsZ0JBRWxCLG9CQUFDLEdBQUQ7QUFBSyxJQUFBLGFBQWEsRUFBQztBQUFuQixLQUNDQyxTQUFTLENBQUN5QyxHQUFWLENBQWM3QixDQUFDLGlCQUNmLG9CQUFDLEdBQUQ7QUFBSyxJQUFBLEdBQUcsRUFBRUE7QUFBVixLQUNFWixTQUFTLENBQUN5QyxHQUFWLENBQWNqQyxDQUFDLGlCQUNmLG9CQUFDLEdBQUQ7QUFBSyxJQUFBLEdBQUcsRUFBRUE7QUFBVixLQUFlVSxPQUFPLENBQUNWLENBQUQsRUFBSUksQ0FBSixFQUFPTyxZQUFQLENBQVAsaUJBQStCLG9CQUFDLElBQUQsY0FBOUMsQ0FEQSxDQURGLENBREEsQ0FERCxDQU5ILENBREQ7QUFvQkEsQ0E1REQ7O0FBOERBdUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCZCxHQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmNvbnN0IFJlYWN0ID0gcmVxdWlyZSgncmVhY3QnKTtcbmNvbnN0IHsgdXNlU3RhdGUsIHVzZUVmZmVjdCwgdXNlQ29udGV4dCB9ID0gcmVxdWlyZSgncmVhY3QnKTtcbmNvbnN0IGltcG9ydEpzeCA9IHJlcXVpcmUoJ2ltcG9ydC1qc3gnKTtcbmNvbnN0IHsgVGV4dCwgQm94IH0gPSByZXF1aXJlKCdpbmsnKTtcbmNvbnN0IHVzZUludGVydmFsID0gcmVxdWlyZSgnLi91c2VJbnRlcnZhbCcpO1xuY29uc3QgeyBkZWZhdWx0OiBTdGRpbkNvbnRleHQgfSA9IHJlcXVpcmUoJ2luay9idWlsZC9jb21wb25lbnRzL1N0ZGluQ29udGV4dCcpO1xuY29uc3QgRGllZFNjcmVlbiA9IGltcG9ydEpzeCgnLi9EaWVkU2NyZWVuJylcblxuXG5jb25zdCBGSUVMRF9TSVpFID0gMTY7XG5jb25zdCBGSUVMRF9ST1cgPSBbLi4ubmV3IEFycmF5KEZJRUxEX1NJWkUpLmtleXMoKV07XG5cbmNvbnN0IEFSUk9XX1VQID0gJ1xcdTAwMUJbQSc7XG5jb25zdCBBUlJPV19ET1dOID0gJ1xcdTAwMUJbQic7XG5jb25zdCBBUlJPV19MRUZUID0gJ1xcdTAwMUJbRCc7XG5jb25zdCBBUlJPV19SSUdIVCA9ICdcXHUwMDFCW0MnO1xuXG5sZXQgZm9vZEl0ZW0gPSB7XG5cdHg6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIEZJRUxEX1NJWkUpLFxuXHR5OiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBGSUVMRF9TSVpFKSxcbn1cblxuY29uc3QgRElSRUNUSU9OID0ge1xuXHRSSUdIVDogeyB4OiAxLCB5OiAwIH0sXG5cdExFRlQ6IHsgeDogLTEsIHk6IDAgfSxcblx0VE9QOiB7IHg6IDAsIHk6IC0xIH0sXG5cdEJPVFRPTTogeyB4OiAwLCB5OiAxIH0sXG59XG5cbmZ1bmN0aW9uIGdldEl0ZW0oeCwgeSwgc25ha2VTZWdlbnRzKSB7XG5cdGlmIChmb29kSXRlbS54ID09PSB4ICYmIGZvb2RJdGVtLnkgPT09IHkpIHtcblx0XHRyZXR1cm4gPFRleHQgY29sb3I9XCJyZWRcIj4g4pagIDwvVGV4dD5cblx0fVxuXHRmb3IgKGNvbnN0IHNlZ21lbnQgb2Ygc25ha2VTZWdlbnRzKSB7XG5cdFx0aWYgKHNlZ21lbnQueCA9PT0geCAmJiBzZWdtZW50LnkgPT09IHkpIHtcblx0XHRcdHJldHVybiA8VGV4dCBjb2xvcj1cImdyZWVuXCI+IOKWoCA8L1RleHQ+XG5cdFx0fVxuXHR9XG59XG5cbmZ1bmN0aW9uIGxpbWl0QnlGaWVsZCh4KSB7XG5cdGlmICh4ID49IEZJRUxEX1NJWkUpIHtcblx0XHRyZXR1cm4gMDtcblx0fVxuXHRpZiAoeCA8IDApIHtcblx0XHRyZXR1cm4gRklFTERfU0laRSAtIDE7XG5cdH1cblx0cmV0dXJuIHg7XG59XG5cbmZ1bmN0aW9uIG5ld1NuYWtlUG9zaXRpb24oc2VnbWVudHMsIGRpcmVjdGlvbikge1xuXHRjb25zdCBbaGVhZF0gPSBzZWdtZW50cztcblx0Y29uc3QgbmV3SGVhZCA9IHtcblx0XHR4OiBsaW1pdEJ5RmllbGQoaGVhZC54ICsgZGlyZWN0aW9uLngpLFxuXHRcdHk6IGxpbWl0QnlGaWVsZChoZWFkLnkgKyBkaXJlY3Rpb24ueSksXG5cdH07XG5cdGlmIChTbmFrZUVhdEZvb2QobmV3SGVhZCwgZm9vZEl0ZW0pKSB7XG5cdFx0Zm9vZEl0ZW0gPSB7XG5cdFx0XHR4OiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBGSUVMRF9TSVpFKSxcblx0XHRcdHk6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIEZJRUxEX1NJWkUpLFxuXHRcdH07XG5cdFx0cmV0dXJuIFtuZXdIZWFkLCAuLi5zZWdtZW50c107XG5cdH1cblx0cmV0dXJuIFtuZXdIZWFkLCAuLi5zZWdtZW50cy5zbGljZSgwLCAtMSldXG59XG5cbmZ1bmN0aW9uIFNuYWtlRWF0Rm9vZChoZWFkLCBmb29kSXRlbSkge1xuXHRyZXR1cm4gaGVhZC54ID09PSBmb29kSXRlbS54ICYmIGhlYWQueSA9PT0gZm9vZEl0ZW0ueVxufVxuXG5jb25zdCBBcHAgPSAoKSA9PiB7XG5cblx0Y29uc3QgW3NuYWtlU2VnZW50cywgc2V0U25ha2VTZWdtZW50c10gPSB1c2VTdGF0ZShbXG5cdFx0eyB4OiA4LCB5OiA4IH0sXG5cdFx0eyB4OiA4LCB5OiA3IH0sXG5cdFx0eyB4OiA4LCB5OiA2IH0sXG5cdF0pO1xuXG5cdGNvbnN0IFtkaXJlY3Rpb24sIHNldERpcmVjdGlvbl0gPSB1c2VTdGF0ZShESVJFQ1RJT04uTEVGVCk7XG5cdGNvbnN0IHsgc3RkaW4sIHNldFJhd01vZGUgfSA9IHVzZUNvbnRleHQoU3RkaW5Db250ZXh0KTtcblxuXHR1c2VFZmZlY3QoKCkgPT4ge1xuXHRcdHNldFJhd01vZGUodHJ1ZSk7XG5cdFx0c3RkaW4ub24oJ2RhdGEnLCBkYXRhID0+IHtcblx0XHRcdGNvbnN0IHZhbHVlID0gZGF0YS50b1N0cmluZygpO1xuXHRcdFx0aWYgKHZhbHVlID09IEFSUk9XX1VQKSB7XG5cdFx0XHRcdHNldERpcmVjdGlvbihESVJFQ1RJT04uVE9QKTtcblx0XHRcdH1cblx0XHRcdGlmICh2YWx1ZSA9PSBBUlJPV19ET1dOKSB7XG5cdFx0XHRcdHNldERpcmVjdGlvbihESVJFQ1RJT04uQk9UVE9NKTtcblx0XHRcdH1cblx0XHRcdGlmICh2YWx1ZSA9PSBBUlJPV19MRUZUKSB7XG5cdFx0XHRcdHNldERpcmVjdGlvbihESVJFQ1RJT04uTEVGVCk7XG5cdFx0XHR9XG5cdFx0XHRpZiAodmFsdWUgPT0gQVJST1dfUklHSFQpIHtcblx0XHRcdFx0c2V0RGlyZWN0aW9uKERJUkVDVElPTi5SSUdIVCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0sIFtdKTtcblxuXHRjb25zdCBbaGVhZCwgLi4udGFpbF0gPSBzbmFrZVNlZ2VudHM7XG5cblx0Y29uc3QgaW50ZXJzZWN0V2l0aEl0c2VsZiA9IHRhaWwuc29tZShcblx0XHRzZWdtZW50ID0+IHNlZ21lbnQueCA9PT0gaGVhZC54ICYmIHNlZ21lbnQueSA9PT0gaGVhZC55XG5cdClcblxuXHR1c2VJbnRlcnZhbCgoKSA9PiB7XG5cdFx0c2V0U25ha2VTZWdtZW50cyhzZWdtZW50cyA9PiBuZXdTbmFrZVBvc2l0aW9uKHNlZ21lbnRzLCBkaXJlY3Rpb24pKVxuXHR9LCBpbnRlcnNlY3RXaXRoSXRzZWxmID8gbnVsbCA6IDgwKTtcblxuXHRyZXR1cm4gKFxuXHRcdDxCb3ggZmxleERpcmVjdGlvbj0nY29sdW1uJyBhbGlnbkl0ZW1zPSdjZW50ZXInPlxuXHRcdFx0PFRleHQ+XG5cdFx0XHRcdDxUZXh0IGNvbG9yPVwiZ3JlZW5cIj5TbmFrZTwvVGV4dD4gZ2FtZVxuXHRcdDwvVGV4dD5cblx0XHRcdHtpbnRlcnNlY3RXaXRoSXRzZWxmID8gKFxuXHRcdFx0XHQ8RGllZFNjcmVlbiBzaXplPXtGSUVMRF9TSVpFfSAvPikgOlxuXHRcdFx0XHQoPEJveCBmbGV4RGlyZWN0aW9uPSdjb2x1bW4nPlxuXHRcdFx0XHRcdHtGSUVMRF9ST1cubWFwKHkgPT4gKFxuXHRcdFx0XHRcdFx0PEJveCBrZXk9e3l9PlxuXHRcdFx0XHRcdFx0XHR7RklFTERfUk9XLm1hcCh4ID0+IChcblx0XHRcdFx0XHRcdFx0XHQ8Qm94IGtleT17eH0gPntnZXRJdGVtKHgsIHksIHNuYWtlU2VnZW50cykgfHwgPFRleHQ+IC4gPC9UZXh0Pn08L0JveD5cblx0XHRcdFx0XHRcdFx0KSl9XG5cdFx0XHRcdFx0XHQ8L0JveD5cblx0XHRcdFx0XHQpKX1cblx0XHRcdFx0PC9Cb3g+KVxuXHRcdFx0fVxuXG5cdFx0PC9Cb3g+XG5cdCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQXBwO1xuXG5cblxuIl19